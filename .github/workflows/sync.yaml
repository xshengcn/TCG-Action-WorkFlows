name: Sync Pokemon TCG Data

on:
  schedule:
    - cron: '0 */2 * * *'  # æ¯2å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
  workflow_dispatch:

env:
  GIT_NAME: "${{ secrets.GIT_NAME }}"
  GIT_EMAIL: "${{ secrets.GIT_EMAIL }}"
  GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}

jobs:
  sync-pokemon-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean old files
        run: |
          echo "åˆ é™¤æ—§æ–‡ä»¶..."
          rm -f README.md tcg-pokemon.json sync-metadata.json
          echo "æ–‡ä»¶æ¸…ç†å®Œæˆ"

      - name: Fetch all Pokemon TCG data
        run: |
          echo "å¼€å§‹è·å– Pokemon TCG æ•°æ®..."
          
          # åˆå§‹åŒ–å˜é‡
          page=1
          pageSize=250
          allCards='[]'
          totalCount=0
          
          echo "æ­£åœ¨è·å–ç¬¬ $page é¡µæ•°æ®..."
          
          # è·å–ç¬¬ä¸€é¡µæ•°æ®ä»¥ç¡®å®šæ€»æ•°
          response=$(curl -s "https://api.pokemontcg.io/v2/cards?page=$page&pageSize=$pageSize")
          totalCount=$(echo "$response" | jq '.totalCount')
          count=$(echo "$response" | jq '.count')
          cards=$(echo "$response" | jq '.data')
          
          # åˆå¹¶ç¬¬ä¸€é¡µæ•°æ®
          allCards=$(echo "$allCards $cards" | jq -s 'add')
          
          echo "æ€»å¡ç‰‡æ•°: $totalCount"
          echo "ç¬¬ $page é¡µè·å–äº† $count å¼ å¡ç‰‡"
          
          # ç»§ç»­è·å–å‰©ä½™é¡µé¢
          while [ "$count" -eq "$pageSize" ]; do
            page=$((page + 1))
            echo "æ­£åœ¨è·å–ç¬¬ $page é¡µæ•°æ®..."
            
            response=$(curl -s "https://api.pokemontcg.io/v2/cards?page=$page&pageSize=$pageSize")
            count=$(echo "$response" | jq '.count')
            cards=$(echo "$response" | jq '.data')
            
            # åˆå¹¶æ•°æ®
            allCards=$(echo "$allCards $cards" | jq -s 'add')
            
            echo "ç¬¬ $page é¡µè·å–äº† $count å¼ å¡ç‰‡"
          done
          
          # åˆ›å»ºæœ€ç»ˆçš„ JSON ç»“æ„
          echo "{\"totalCount\": $totalCount, \"data\": $allCards}" | jq -c . > tcg-pokemon.json
          
          echo "æ•°æ®è·å–å®Œæˆï¼Œå…± $(echo "$allCards" | jq length) å¼ å¡ç‰‡"

      - name: Write sync metadata
        run: |
          echo "å†™å…¥åŒæ­¥å…ƒæ•°æ®..."
          
          totalCards=$(jq '.totalCount' tcg-pokemon.json)
          currentTime=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          
          # è®¡ç®— set æ•°é‡ï¼ˆæŒ‰ set.id å»é‡ï¼‰
          setCount=$(jq '[.data[].set.id] | unique | length' tcg-pokemon.json)
          
          # åˆ›å»ºå…ƒæ•°æ®æ–‡ä»¶
          jq -n \
            --arg timestamp "$currentTime" \
            --argjson totalCards "$totalCards" \
            --argjson setCount "$setCount" \
            '{
              timestamp: $timestamp,
              totalCards: $totalCards,
              setCount: $setCount
            }' > sync-metadata.json
          
          echo "å…ƒæ•°æ®å†™å…¥å®Œæˆ"

      - name: Transform data structure by sets
        run: |
          echo "æŒ‰ set é‡æ„æ•°æ®ç»“æ„..."
          
          # æŒ‰ set.id åˆ†ç»„å¹¶é‡æ„æ•°æ®
          jq '{
            totalCount: .totalCount,
            data: [
              group_by(.set.id)[] | {
                set: .[0].set,
                cards: .
              }
            ]
          }' tcg-pokemon.json > tcg-pokemon-temp.json
          
          # å‹ç¼©å¹¶æ›¿æ¢åŸæ–‡ä»¶
          jq -c . tcg-pokemon-temp.json > tcg-pokemon.json
          rm tcg-pokemon-temp.json
          
          echo "æ•°æ®ç»“æ„è½¬æ¢å®Œæˆ"

      - name: Compress JSON file
        run: |
          echo "å‹ç¼© JSON æ–‡ä»¶..."
          
          # ç¡®ä¿æ–‡ä»¶æ˜¯å‹ç¼©æ ¼å¼ï¼ˆç§»é™¤å¤šä½™ç©ºæ ¼å’Œæ¢è¡Œï¼‰
          jq -c . tcg-pokemon.json > tcg-pokemon-compressed.json
          mv tcg-pokemon-compressed.json tcg-pokemon.json
          
          # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
          fileSize=$(du -h tcg-pokemon.json | cut -f1)
          echo "å‹ç¼©åæ–‡ä»¶å¤§å°: $fileSize"

      - name: Generate README.md
        run: |
          echo "ç”Ÿæˆ README.md..."
          
          # è¯»å–å…ƒæ•°æ®
          timestamp=$(jq -r '.timestamp' sync-metadata.json)
          totalCards=$(jq -r '.totalCards' sync-metadata.json)
          setCount=$(jq -r '.setCount' sync-metadata.json)
          
          # ä½¿ç”¨ echo ç”Ÿæˆ README å†…å®¹
          echo "# Pokemon TCG æ•°æ®åŒæ­¥" > README.md
          echo "" >> README.md
          echo "## $timestamp" >> README.md
          echo "" >> README.md
          echo "## æ•°æ®ç»Ÿè®¡" >> README.md
          echo "- **æ€»å¡ç‰‡æ•°é‡**: $totalCards å¼ " >> README.md
          echo "- **å¡ç»„æ•°é‡**: $setCount ä¸ª" >> README.md
          echo "- **æ•°æ®æ¥æº**: [Pokemon TCG API](https://pokemontcg.io/)" >> README.md
          echo "" >> README.md
          echo "## æ•°æ®ç»“æ„" >> README.md
          echo "\`\`\`json" >> README.md
          echo "{" >> README.md
          echo "  \"totalCount\": æ•°å­—," >> README.md
          echo "  \"data\": [" >> README.md
          echo "    {" >> README.md
          echo "      \"set\": {" >> README.md
          echo "        \"id\": \"set_id\"," >> README.md
          echo "        \"name\": \"set_name\"" >> README.md
          echo "      }," >> README.md
          echo "      \"cards\": [...]" >> README.md
          echo "    }" >> README.md
          echo "  ]" >> README.md
          echo "}" >> README.md
          echo "\`\`\`" >> README.md
          echo "" >> README.md
          echo "## è‡ªåŠ¨æ›´æ–°" >> README.md
          echo "æ­¤æ•°æ®æ¯2å°æ—¶è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ï¼Œç¡®ä¿æ•°æ®çš„æ—¶æ•ˆæ€§ã€‚" >> README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "*æ•°æ®ç”± GitHub Actions è‡ªåŠ¨ç»´æŠ¤*" >> README.md
          
          echo "README.md ç”Ÿæˆå®Œæˆ"

      - name: Commit and push changes
        run: |
          echo "æäº¤æ›´æ”¹..."
          
          # é…ç½® Git
          git config --local user.email "$GIT_EMAIL"
          git config --local user.name "$GIT_NAME"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet && git diff --cached --quiet; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶å¹¶æäº¤
          git add .
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          totalCards=$(jq -r '.totalCards' sync-metadata.json)
          setCount=$(jq -r '.setCount' sync-metadata.json)
          commitMsg="ğŸ“± æ›´æ–° Pokemon TCG æ•°æ® - $totalCards å¼ å¡ç‰‡, $setCount ä¸ªå¡ç»„"
          
          git commit -m "$commitMsg"
          
          echo "æäº¤å®Œæˆï¼Œå‡†å¤‡æ¨é€..."

      - name: Push to repository
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.MY_GITHUB_TOKEN }}
          branch: main

      - name: Summary
        run: |
          echo "ğŸ‰ åŒæ­¥å®Œæˆ!"
          echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:"
          echo "   - æ€»å¡ç‰‡æ•°: $(jq -r '.totalCards' sync-metadata.json)"
          echo "   - å¡ç»„æ•°é‡: $(jq -r '.setCount' sync-metadata.json)"
          echo "   - æ›´æ–°æ—¶é—´: $(jq -r '.timestamp' sync-metadata.json)"