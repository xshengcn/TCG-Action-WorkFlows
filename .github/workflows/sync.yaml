name: SYNC POKEMON TCG

on:
  schedule:
    - cron: '0 */2 * * *'  # æ¯2å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆUTCï¼‰
  workflow_dispatch:

permissions:
  contents: write

env:
  GIT_NAME: "${{ secrets.GIT_NAME }}"
  GIT_EMAIL: "${{ secrets.GIT_EMAIL }}"
  GITHUB_TOKEN: "${{ secrets.MY_GITHUB_TOKEN }}"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Delete local files
        run: |
          echo "ğŸ”· æ­£åœ¨æ‰§è¡Œæ­¥éª¤ï¼šDelete local files"
          rm -f README.md 
          rm -f tcg-pokemon.old.json
          cp tcg-pokemon.json tcg-pokemon.old.json 2>/dev/null || true
          rm -f tcg-pokemon.json
          rm -f sync-metadata.json

      - name: Get PokÃ©mon TCG cards data
        run: |
          echo "ğŸ”· æ­£åœ¨æ‰§è¡Œæ­¥éª¤ï¼šGet PokÃ©mon TCG cards data"

          echo "ğŸ§¹ åˆå§‹åŒ– tcg-pokemon.json..."
          echo '{"data": [], "totalCount": 0}' > tcg-pokemon.json

          page=1
          pageSize=250

          echo "ğŸŒ æ­£åœ¨è·å–ç¬¬ $page é¡µæ•°æ®..."
          curl -sS "https://api.pokemontcg.io/v2/cards?page=$page&pageSize=$pageSize" > temp.json

          echo "ğŸ“Š è¯»å– totalCount..."
          totalCount=$(jq '.totalCount' temp.json)
          echo "ğŸ‘‰ å…± $totalCount å¼ å¡ç‰‡"

          echo "ğŸ“¦ å†™å…¥ totalCount åˆ° tcg-pokemon.json..."
          jq ".totalCount = $totalCount" tcg-pokemon.json > tcg-pokemon.tmp.json
          jq -c . tcg-pokemon.tmp.json > tcg-pokemon.json && rm tcg-pokemon.tmp.json

          count=$(jq '.count' temp.json)

          echo "ğŸ” å¼€å§‹åˆ†é¡µæŠ“å–ä¸åˆå¹¶..."
          while [ $count -eq $pageSize ]; do
            echo "â• åˆå¹¶ç¬¬ $page é¡µæ•°æ®..."
            jq -s '.[0].data += .[1].data | .[0]' tcg-pokemon.json temp.json > tcg-pokemon.tmp.json
            jq -c . tcg-pokemon.tmp.json > tcg-pokemon.json && rm tcg-pokemon.tmp.json

            page=$((page + 1))
            echo "ğŸŒ æ­£åœ¨è·å–ç¬¬ $page é¡µæ•°æ®..."
            curl -sS "https://api.pokemontcg.io/v2/cards?page=$page&pageSize=$pageSize" > temp.json
            count=$(jq '.count' temp.json)
          done

          echo "â• åˆå¹¶æœ€åä¸€é¡µæ•°æ®..."
          jq -s '.[0].data += .[1].data | .[0]' tcg-pokemon.json temp.json > tcg-pokemon.tmp.json
          jq -c . tcg-pokemon.tmp.json > tcg-pokemon.json && rm tcg-pokemon.tmp.json

          echo "ğŸ§¼ åˆ é™¤ä¸´æ—¶æ–‡ä»¶..."
          rm -f temp.json

          card_count=$(jq '[.data[]] | length' tcg-pokemon.json)
          echo "âœ… æ•°æ®è·å–å®Œæˆï¼Œå…± $card_count å¼ å¡ç‰‡"

      - name: Transform data structure
        run: |
          echo "ğŸ”· æ­£åœ¨æ‰§è¡Œæ­¥éª¤ï¼šTransform data structure"

          jq '{
            totalCount: .totalCount,
            data: (
              .data
              | sort_by(.set.id)
              | group_by(.set.id)
              | map({
                  id: .[0].set.id,
                  name: .[0].set.name,
                  cards: map(del(.set))
                })
            )
          }' tcg-pokemon.json > tcg-pokemon.tmp.json

          jq -c . tcg-pokemon.tmp.json > tcg-pokemon.json && rm tcg-pokemon.tmp.json
          echo "âœ… æ•°æ®ç»“æ„è½¬æ¢å®Œæˆ"

      - name: Record sync metadata
        run: |
          echo "ğŸ”· æ­£åœ¨æ‰§è¡Œæ­¥éª¤ï¼šRecord sync metadata"

          timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          totalCards=$(jq '[.data[].cards[]] | length' tcg-pokemon.json)
          setCount=$(jq '.data | length' tcg-pokemon.json)

          version=1
          if [ -f sync-metadata.json ]; then
            old_version=$(jq -r '.version // 1' sync-metadata.json)
            version=$old_version
          fi

          if [ -f tcg-pokemon.old.json ]; then
            if ! diff -q tcg-pokemon.old.json tcg-pokemon.json > /dev/null; then
              echo "ğŸ”„ æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œç‰ˆæœ¬å· +1"
              version=$((version + 1))
            else
              echo "âœ… æ•°æ®æ— å˜åŒ–ï¼Œç‰ˆæœ¬å·ä¿æŒä¸º $version"
            fi
            rm -f tcg-pokemon.old.json
          fi

          jq -n \
            --arg ts "$timestamp" \
            --argjson cards "$totalCards" \
            --argjson setCount "$setCount" \
            --argjson version "$version" \
            '{timestamp: $ts, totalCards: $cards, setCount: $setCount, version: $version}' > sync-metadata.json

          echo "âœ… å†™å…¥ sync-metadata.jsonï¼ˆç‰ˆæœ¬ï¼šv$versionï¼‰å®Œæˆ"

      - name: Add version to tcg-pokemon.json
        run: |
          echo "ğŸ”· æ­£åœ¨æ‰§è¡Œæ­¥éª¤ï¼šAdd version to tcg-pokemon.json"

          version=$(jq -r '.version' sync-metadata.json)

          jq --argjson version "$version" '.version = $version | .' tcg-pokemon.json > tcg-pokemon.tmp.json
          jq -c . tcg-pokemon.tmp.json > tcg-pokemon.json && rm tcg-pokemon.tmp.json

          echo "âœ… å·²æ·»åŠ  version å­—æ®µåˆ° tcg-pokemon.jsonï¼ˆv$versionï¼‰"

      - name: Update README.md
        run: |
          echo "ğŸ”· æ­£åœ¨æ‰§è¡Œæ­¥éª¤ï¼šUpdate README.md"
          echo "ç”Ÿæˆ README.md..."

          timestamp=$(jq -r '.timestamp' sync-metadata.json)
          totalCards=$(jq -r '.totalCards' sync-metadata.json)
          setCount=$(jq -r '.setCount' sync-metadata.json)
          version=$(jq -r '.version' sync-metadata.json)

          echo "# Pokemon TCG æ•°æ®åŒæ­¥" > README.md
          echo "" >> README.md
          echo "## $timestamp" >> README.md
          echo "" >> README.md
          echo "## æ•°æ®ç»Ÿè®¡" >> README.md
          echo "- **ç‰ˆæœ¬å·**: v$version" >> README.md
          echo "- **æ€»å¡ç‰‡æ•°é‡**: $totalCards å¼ " >> README.md
          echo "- **å¡ç»„æ•°é‡**: $setCount ä¸ª" >> README.md
          echo "- **æ•°æ®æ¥æº**: [Pokemon TCG API](https://pokemontcg.io/)" >> README.md
          echo "" >> README.md
          echo "## æ•°æ®ç»“æ„" >> README.md
          echo "\`\`\`json" >> README.md
          echo "{" >> README.md
          echo "  \"totalCount\": æ•°å­—," >> README.md
          echo "  \"version\": æ•°å­—," >> README.md
          echo "  \"data\": [" >> README.md
          echo "    {" >> README.md
          echo "      \"set\": {" >> README.md
          echo "        \"id\": \"set_id\"," >> README.md
          echo "        \"name\": \"set_name\"" >> README.md
          echo "      }," >> README.md
          echo "      \"cards\": [...]" >> README.md
          echo "    }" >> README.md
          echo "  ]" >> README.md
          echo "}" >> README.md
          echo "\`\`\`" >> README.md
          echo "" >> README.md
          echo "## è‡ªåŠ¨æ›´æ–°" >> README.md
          echo "æ­¤æ•°æ®æ¯2å°æ—¶è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ï¼Œç¡®ä¿æ•°æ®çš„æ—¶æ•ˆæ€§ã€‚" >> README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "*æ•°æ®ç”± GitHub Actions è‡ªåŠ¨ç»´æŠ¤*" >> README.md

          echo "âœ… README.md ç”Ÿæˆå®Œæˆ"

      - name: Commit changes
        run: |
          echo "ğŸ”· æ­£åœ¨æ‰§è¡Œæ­¥éª¤ï¼šCommit changes"
          git config --local user.email "$GIT_EMAIL"
          git config --local user.name "$GIT_NAME"
          git add .
          if git diff --cached --quiet; then
            echo "âœ… æ— å˜æ›´ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "update"
            echo "âœ… Git æäº¤å®Œæˆ"
          fi

      - name: Push changes
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: "${{ secrets.MY_GITHUB_TOKEN }}"
          branch: main

      - name: Summary
        run: |
          echo "ğŸ‰ åŒæ­¥å®Œæˆ!"
          echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:"
          echo "   - æ€»å¡ç‰‡æ•°: $(jq -r '.totalCards' sync-metadata.json)"
          echo "   - å¡ç»„æ•°é‡: $(jq -r '.setCount' sync-metadata.json)"
          echo "   - æ›´æ–°æ—¶é—´: $(jq -r '.timestamp' sync-metadata.json)"
          echo "   - å½“å‰ç‰ˆæœ¬: v$(jq -r '.version' sync-metadata.json)"