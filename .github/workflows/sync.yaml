name: Sync Pokemon TCG Data

on:
  schedule:
    - cron: '0 */2 * * *'  # æ¯2å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
  workflow_dispatch:

env:
  GIT_NAME: "${{ secrets.GIT_NAME }}"
  GIT_EMAIL: "${{ secrets.GIT_EMAIL }}"
  GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}

jobs:
  sync-pokemon-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean old files
        run: |
          echo "åˆ é™¤æ—§æ–‡ä»¶..."
          rm -f README.md tcg-pokemon.json sync-metadata.json tcg-pokemon-temp.json
          echo "æ–‡ä»¶æ¸…ç†å®Œæˆ"

      - name: Fetch all Pokemon TCG data
        run: |
          echo "å¼€å§‹è·å– Pokemon TCG æ•°æ®..."
          
          # åˆå§‹åŒ–å˜é‡
          page=1
          pageSize=250
          totalCount=0
          
          echo "æ­£åœ¨è·å–ç¬¬ $page é¡µæ•°æ®..."
          
          # è·å–ç¬¬ä¸€é¡µæ•°æ®ä»¥ç¡®å®šæ€»æ•°
          response=$(curl -s "https://api.pokemontcg.io/v2/cards?page=$page&pageSize=$pageSize")
          
          # æ£€æŸ¥ API å“åº”æ˜¯å¦æœ‰æ•ˆ
          if ! echo "$response" | jq empty 2>/dev/null; then
            echo "API å“åº”æ— æ•ˆï¼Œé€€å‡º"
            exit 1
          fi
          
          totalCount=$(echo "$response" | jq -r '.totalCount // 0')
          count=$(echo "$response" | jq -r '.count // 0')
          
          # åˆ›å»ºä¸´æ—¶ JSON æ–‡ä»¶ï¼Œä¿å­˜åŸå§‹ç»“æ„
          echo "$response" | jq '{totalCount: .totalCount, data: .data}' > tcg-pokemon-temp.json
          
          echo "æ€»å¡ç‰‡æ•°: $totalCount"
          echo "ç¬¬ $page é¡µè·å–äº† $count å¼ å¡ç‰‡"
          
          # ç»§ç»­è·å–å‰©ä½™é¡µé¢ï¼Œåˆå¹¶åˆ°ä¸´æ—¶æ–‡ä»¶
          while [ "$count" -eq "$pageSize" ] && [ "$count" -gt 0 ]; do
            page=$((page + 1))
            echo "æ­£åœ¨è·å–ç¬¬ $page é¡µæ•°æ®..."
            
            response=$(curl -s "https://api.pokemontcg.io/v2/cards?page=$page&pageSize=$pageSize")
            
            # æ£€æŸ¥å“åº”æœ‰æ•ˆæ€§
            if ! echo "$response" | jq empty 2>/dev/null; then
              echo "ç¬¬ $page é¡µå“åº”æ— æ•ˆï¼Œåœæ­¢è·å–"
              break
            fi
            
            count=$(echo "$response" | jq -r '.count // 0')
            
            if [ "$count" -gt 0 ]; then
              # åˆå¹¶æ•°æ®åˆ°ä¸´æ—¶æ–‡ä»¶
              jq --argjson newData "$(echo "$response" | jq '.data')" \
                '.data += $newData' tcg-pokemon-temp.json > tcg-pokemon-temp-merged.json && \
                mv tcg-pokemon-temp-merged.json tcg-pokemon-temp.json
              
              echo "ç¬¬ $page é¡µè·å–äº† $count å¼ å¡ç‰‡"
            fi
          done
          
          # éªŒè¯ä¸´æ—¶æ–‡ä»¶æ•°æ®
          finalCount=$(jq '.data | length' tcg-pokemon-temp.json)
          echo "æ•°æ®è·å–å®Œæˆï¼Œå…± $finalCount å¼ å¡ç‰‡å·²ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶"
          
          # æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
          if [ "$finalCount" -eq 0 ]; then
            echo "é”™è¯¯ï¼šæœªè·å–åˆ°ä»»ä½•å¡ç‰‡æ•°æ®"
            exit 1
          fi

      - name: Transform data structure by sets
        run: |
          echo "ä»ä¸´æ—¶æ–‡ä»¶è½¬æ¢æ•°æ®ç»“æ„..."
          
          # éªŒè¯ä¸´æ—¶æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "tcg-pokemon-temp.json" ]; then
            echo "é”™è¯¯ï¼šä¸´æ—¶æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # éªŒè¯æ•°æ®ç»“æ„æ˜¯å¦æ­£ç¡®
          if ! jq -e '.data | type == "array"' tcg-pokemon-temp.json > /dev/null; then
            echo "é”™è¯¯ï¼šä¸´æ—¶æ–‡ä»¶ä¸­çš„ data å­—æ®µä¸æ˜¯æ•°ç»„"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å¡ç‰‡æ•°æ®
          cardCount=$(jq '.data | length' tcg-pokemon-temp.json)
          if [ "$cardCount" -eq 0 ]; then
            echo "é”™è¯¯ï¼šä¸´æ—¶æ–‡ä»¶ä¸­æ²¡æœ‰å¡ç‰‡æ•°æ®å¯ä»¥è½¬æ¢"
            exit 1
          fi
          
          echo "å‡†å¤‡è½¬æ¢ $cardCount å¼ å¡ç‰‡..."
          
          # éªŒè¯ç¬¬ä¸€å¼ å¡ç‰‡æ˜¯å¦æœ‰ set å­—æ®µ
          if ! jq -e '.data[0].set' tcg-pokemon-temp.json > /dev/null; then
            echo "é”™è¯¯ï¼šå¡ç‰‡æ•°æ®ç¼ºå°‘ set å­—æ®µ"
            jq '.data[0]' tcg-pokemon-temp.json
            exit 1
          fi
          
          # ä»ä¸´æ—¶æ–‡ä»¶æŒ‰ set.id åˆ†ç»„ï¼Œå°† set ä½œä¸ºä¸»ä½“ï¼Œcards å»æ‰ set å±æ€§
          jq '{
            totalCount: .totalCount,
            data: [
              .data | group_by(.set.id)[] | 
              (.[0].set + {
                cards: [.[] | del(.set)]
              })
            ]
          }' tcg-pokemon-temp.json > tcg-pokemon.json
          
          # éªŒè¯è½¬æ¢ç»“æœ
          if jq -e '.data | type == "array" and length > 0' tcg-pokemon.json > /dev/null; then
            setCount=$(jq '.data | length' tcg-pokemon.json)
            echo "æ•°æ®ç»“æ„è½¬æ¢å®Œæˆï¼Œå…± $setCount ä¸ªå¡ç»„"
            
            # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
            rm tcg-pokemon-temp.json
            echo "ä¸´æ—¶æ–‡ä»¶å·²åˆ é™¤"
          else
            echo "é”™è¯¯ï¼šæ•°æ®è½¬æ¢å¤±è´¥"
            exit 1
          fi

      - name: Write sync metadata
        run: |
          echo "å†™å…¥åŒæ­¥å…ƒæ•°æ®..."
          
          totalCards=$(jq '.totalCount' tcg-pokemon.json)
          currentTime=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          
          # è®¡ç®— set æ•°é‡ï¼ˆæŒ‰ set.id å»é‡ï¼‰
          setCount=$(jq '.data | length' tcg-pokemon.json)
          
          # åˆ›å»ºå…ƒæ•°æ®æ–‡ä»¶
          jq -n \
            --arg timestamp "$currentTime" \
            --argjson totalCards "$totalCards" \
            --argjson setCount "$setCount" \
            '{
              timestamp: $timestamp,
              totalCards: $totalCards,
              setCount: $setCount
            }' > sync-metadata.json
          
          echo "å…ƒæ•°æ®å†™å…¥å®Œæˆ"

      - name: Compress JSON file
        run: |
          echo "å‹ç¼© JSON æ–‡ä»¶..."
          
          # ç¡®ä¿æ–‡ä»¶æ˜¯å‹ç¼©æ ¼å¼ï¼ˆç§»é™¤å¤šä½™ç©ºæ ¼å’Œæ¢è¡Œï¼‰
          jq -c . tcg-pokemon.json > tcg-pokemon-compressed.json
          mv tcg-pokemon-compressed.json tcg-pokemon.json
          
          # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
          fileSize=$(du -h tcg-pokemon.json | cut -f1)
          echo "å‹ç¼©åæ–‡ä»¶å¤§å°: $fileSize"

      - name: Generate README.md
        run: |
          echo "ç”Ÿæˆ README.md..."
          
          # è¯»å–å…ƒæ•°æ®
          timestamp=$(jq -r '.timestamp' sync-metadata.json)
          totalCards=$(jq -r '.totalCards' sync-metadata.json)
          setCount=$(jq -r '.setCount' sync-metadata.json)
          
          # ä½¿ç”¨ echo ç”Ÿæˆ README å†…å®¹
          echo "# Pokemon TCG æ•°æ®åŒæ­¥" > README.md
          echo "" >> README.md
          echo "## $timestamp" >> README.md
          echo "" >> README.md
          echo "## æ•°æ®ç»Ÿè®¡" >> README.md
          echo "- **æ€»å¡ç‰‡æ•°é‡**: $totalCards å¼ " >> README.md
          echo "- **å¡ç»„æ•°é‡**: $setCount ä¸ª" >> README.md
          echo "- **æ•°æ®æ¥æº**: [Pokemon TCG API](https://pokemontcg.io/)" >> README.md
          echo "" >> README.md
          echo "## æ•°æ®ç»“æ„" >> README.md
          echo "\`\`\`json" >> README.md
          echo "{" >> README.md
          echo "  \"totalCount\": æ•°å­—," >> README.md
          echo "  \"data\": [" >> README.md
          echo "    {" >> README.md
          echo "      \"set\": {" >> README.md
          echo "        \"id\": \"set_id\"," >> README.md
          echo "        \"name\": \"set_name\"" >> README.md
          echo "      }," >> README.md
          echo "      \"cards\": [...]" >> README.md
          echo "    }" >> README.md
          echo "  ]" >> README.md
          echo "}" >> README.md
          echo "\`\`\`" >> README.md
          echo "" >> README.md
          echo "## è‡ªåŠ¨æ›´æ–°" >> README.md
          echo "æ­¤æ•°æ®æ¯2å°æ—¶è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ï¼Œç¡®ä¿æ•°æ®çš„æ—¶æ•ˆæ€§ã€‚" >> README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "*æ•°æ®ç”± GitHub Actions è‡ªåŠ¨ç»´æŠ¤*" >> README.md
          
          echo "README.md ç”Ÿæˆå®Œæˆ"

      - name: Commit and push changes
        run: |
          echo "æäº¤æ›´æ”¹..."
          
          # é…ç½® Git
          git config --local user.email "$GIT_EMAIL"
          git config --local user.name "$GIT_NAME"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet && git diff --cached --quiet; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶å¹¶æäº¤
          git add .
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          totalCards=$(jq -r '.totalCards' sync-metadata.json)
          setCount=$(jq -r '.setCount' sync-metadata.json)
          commitMsg="ğŸ“± æ›´æ–° Pokemon TCG æ•°æ® - $totalCards å¼ å¡ç‰‡, $setCount ä¸ªå¡ç»„"
          
          git commit -m "$commitMsg"
          
          echo "æäº¤å®Œæˆï¼Œå‡†å¤‡æ¨é€..."

      - name: Push to repository
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.MY_GITHUB_TOKEN }}
          branch: main

      - name: Summary
        run: |
          echo "ğŸ‰ åŒæ­¥å®Œæˆ!"
          echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:"
          echo "   - æ€»å¡ç‰‡æ•°: $(jq -r '.totalCards' sync-metadata.json)"
          echo "   - å¡ç»„æ•°é‡: $(jq -r '.setCount' sync-metadata.json)"
          echo "   - æ›´æ–°æ—¶é—´: $(jq -r '.timestamp' sync-metadata.json)"